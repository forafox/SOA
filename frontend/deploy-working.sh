#!/bin/bash

# –†–∞–±–æ—á–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è —Å—Ç–∞—Ç–∏–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-working.sh [—Å–µ—Ä–≤–µ—Ä_–∞–ª–∏–∞—Å] [movies_api_url] [oscars_api_url]

# –ü–æ–ª—É—á–∞–µ–º –∞–ª–∏–∞—Å —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∏–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
if [ -z "$1" ]; then
    echo "üìù –í–≤–µ–¥–∏—Ç–µ –∞–ª–∏–∞—Å —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: helios):"
    read SERVER_ALIAS
else
    SERVER_ALIAS="$1"
fi

if [ -z "$SERVER_ALIAS" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –∞–ª–∏–∞—Å —Å–µ—Ä–≤–µ—Ä–∞"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-working.sh [—Å–µ—Ä–≤–µ—Ä_–∞–ª–∏–∞—Å] [movies_api_url] [oscars_api_url]"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º URL API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
MOVIES_API_URL="$2"
OSCARS_API_URL="$3"

echo "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API:"
if [ -n "$MOVIES_API_URL" ]; then
    echo "   Movies API: $MOVIES_API_URL"
    export NEXT_PUBLIC_MOVIES_API_URL="$MOVIES_API_URL"
fi
if [ -n "$OSCARS_API_URL" ]; then
    echo "   Oscars API: $OSCARS_API_URL"
    export NEXT_PUBLIC_OSCARS_API_URL="$OSCARS_API_URL"
fi

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π —Å—Ç–∞—Ç–∏–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: $SERVER_ALIAS"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: package.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞."
    exit 1
fi

# –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É
echo "üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É..."
rm -rf out

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
echo "üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏..."
NODE_ENV=production npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
if [ ! -d "out" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ out –Ω–µ —Å–æ–∑–¥–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Next.js."
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤
echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è:"
echo "   - index.html (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏ /~s367268/soa/)"
echo "   - _next/static/chunks/ (JS —Ñ–∞–π–ª—ã)"
echo "   - _next/static/css/ (CSS —Ñ–∞–π–ª—ã)"
echo "   - _next/static/media/ (—à—Ä–∏—Ñ—Ç—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)"
echo "   - favicon.ico"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä $SERVER_ALIAS..."
rsync -av --delete out/ "$SERVER_ALIAS:~/public_html/soa/"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ $? -eq 0 ]; then
    echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo "üåê –í–∞—à —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://se.ifmo.ru/~s367268/soa/"
    echo ""
    echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
    echo "   ssh $SERVER_ALIAS 'ls -la ~/public_html/soa/_next/static/'"
    echo ""
    echo "üîß –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "   1. –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    echo "   2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (Apache/Nginx)"
    echo "   3. –õ–æ–≥–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ—à–∏–±–æ–∫ 404"
    echo ""
    echo "üéØ –¢–µ–ø–µ—Ä—å –≤—Å–µ –ø—É—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏:"
    echo "   - JS: /~s367268/soa/_next/static/chunks/"
    echo "   - CSS: /~s367268/soa/_next/static/css/"
    echo "   - –®—Ä–∏—Ñ—Ç—ã: /~s367268/soa/_next/static/media/"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
    exit 1
fi
